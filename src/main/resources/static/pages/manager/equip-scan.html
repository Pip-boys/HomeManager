<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>设备扫描</title>
<meta name="description" content="这是一个 index 页面">
<meta name="keywords" content="index">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="renderer" content="webkit">
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="icon" type="image/png"
	href="../../js/amazeUI/assets/i/favicon.png">
<link rel="apple-touch-icon-precomposed"
	href="../../js/amazeUI/assets/i/app-icon72x72@2x.png">
<meta name="apple-mobile-web-app-title" content="Amaze UI" />
<script src="../../js/amazeUI/assets/js/echarts.min.js"></script>
<link rel="stylesheet"
	href="../../js/amazeUI/assets/css/amazeui.min.css" />
<link rel="stylesheet"
	href="../../js/amazeUI/assets/css/amazeui.datatables.min.css" />
<link rel="stylesheet" href="../../js/amazeUI/assets/css/app.css">
<link rel="stylesheet" href="../../css/mricode.pagination.css">
<script src="../../js/amazeUI/assets/js/jquery.min.js"></script>
<script type="text/javascript"
	src="../../js/common/mricode.pagination.js"></script>
<script type="text/javascript" src="../../js/common/init-common-jq.js"></script>
<script type="text/javascript" src="../../js/qrcode/qrcode.js"></script>
</head>

<body data-type="widgets" >
	<script src="../../js/amazeUI/assets/js/theme.js"></script>
	
	<div class="am-g tpl-g">
		<!-- 头部 -->
		<header>
			<!-- logo -->
			<div class="am-fl tpl-header-logo">
				<a href="host"><img
					src="../../js/amazeUI/assets/img/logo.png" alt=""></a>
			</div>
			<!-- 右侧内容 -->
			<div class="tpl-header-fluid">
				<!-- 侧边切换 -->
				<div class="am-fl tpl-header-switch-button am-icon-list">
					<span> </span>
				</div>
				<!-- 搜索 -->
				<div class="am-fl tpl-header-search">
					<form class="tpl-header-search-form" action="javascript:;">
						<button class="tpl-header-search-btn am-icon-search"></button>
						<input class="tpl-header-search-box" type="text"
							placeholder="搜索内容...">
					</form>
				</div>
				<!-- 其它功能-->
				<div class="am-fr tpl-header-navbar">
					<ul>
						<!-- 欢迎语 -->
						<li class="am-text-sm tpl-header-navbar-welcome"><a
							href="javascript:;">欢迎你, <span>Amaze UI</span>
						</a></li>

						<!-- 新邮件 -->
						<li class="am-dropdown tpl-dropdown" data-am-dropdown><a
							href="javascript:;"
							class="am-dropdown-toggle tpl-dropdown-toggle"
							data-am-dropdown-toggle> <i class="am-icon-envelope"></i> <span
								class="am-badge am-badge-success am-round item-feed-badge">4</span>
						</a> <!-- 弹出列表 -->
							<ul class="am-dropdown-content tpl-dropdown-content">
								<li class="tpl-dropdown-menu-messages"><a
									href="javascript:;"
									class="tpl-dropdown-menu-messages-item am-cf">
										<div class="menu-messages-ico">
											<img src="../../js/amazeUI/assets/img/user04.png" alt="">
										</div>
										<div class="menu-messages-time">3小时前</div>
										<div class="menu-messages-content">
											<div class="menu-messages-content-title">
												<i class="am-icon-circle-o am-text-success"></i> <span>夕风色</span>
											</div>
											<div class="am-text-truncate">Amaze UI 的诞生，依托于 GitHub
												及其他技术社区上一些优秀的资源；Amaze UI 的成长，则离不开用户的支持。</div>
											<div class="menu-messages-content-time">2016-09-21 下午
												16:40</div>
										</div>
								</a></li>

								<li class="tpl-dropdown-menu-messages"><a
									href="javascript:;"
									class="tpl-dropdown-menu-messages-item am-cf">
										<div class="menu-messages-ico">
											<img src="../../js/amazeUI/assets/img/user02.png" alt="">
										</div>
										<div class="menu-messages-time">5天前</div>
										<div class="menu-messages-content">
											<div class="menu-messages-content-title">
												<i class="am-icon-circle-o am-text-warning"></i> <span>禁言小张</span>
											</div>
											<div class="am-text-truncate">为了能最准确的传达所描述的问题，
												建议你在反馈时附上演示，方便我们理解。</div>
											<div class="menu-messages-content-time">2016-09-16 上午
												09:23</div>
										</div>
								</a></li>
								<li class="tpl-dropdown-menu-messages"><a
									href="javascript:;"
									class="tpl-dropdown-menu-messages-item am-cf"> <i
										class="am-icon-circle-o"></i> 进入列表…
								</a></li>
							</ul></li>

						<!-- 新提示 -->
						<li class="am-dropdown" data-am-dropdown><a
							href="javascript:;" class="am-dropdown-toggle"
							data-am-dropdown-toggle> <i class="am-icon-bell"></i> <span
								class="am-badge am-badge-warning am-round item-feed-badge">5</span>
						</a> <!-- 弹出列表 -->
							<ul class="am-dropdown-content tpl-dropdown-content">
								<li class="tpl-dropdown-menu-notifications"><a
									href="javascript:;"
									class="tpl-dropdown-menu-notifications-item am-cf">
										<div class="tpl-dropdown-menu-notifications-title">
											<i class="am-icon-line-chart"></i> <span> 有6笔新的销售订单</span>
										</div>
										<div class="tpl-dropdown-menu-notifications-time">12分钟前
										</div>
								</a></li>
								<li class="tpl-dropdown-menu-notifications"><a
									href="javascript:;"
									class="tpl-dropdown-menu-notifications-item am-cf">
										<div class="tpl-dropdown-menu-notifications-title">
											<i class="am-icon-star"></i> <span> 有3个来自人事部的消息</span>
										</div>
										<div class="tpl-dropdown-menu-notifications-time">30分钟前
										</div>
								</a></li>
								<li class="tpl-dropdown-menu-notifications"><a
									href="javascript:;"
									class="tpl-dropdown-menu-notifications-item am-cf">
										<div class="tpl-dropdown-menu-notifications-title">
											<i class="am-icon-folder-o"></i> <span> 上午开会记录存档</span>
										</div>
										<div class="tpl-dropdown-menu-notifications-time">1天前</div>
								</a></li>


								<li class="tpl-dropdown-menu-notifications"><a
									href="javascript:;"
									class="tpl-dropdown-menu-notifications-item am-cf"> <i
										class="am-icon-bell"></i> 进入列表…
								</a></li>
							</ul></li>

						<!-- 退出 -->
						<li class="am-text-sm"><a href="/logout"> <span
								class="am-icon-sign-out"></span> 退出
						</a></li>
					</ul>
				</div>
			</div>

		</header>
		<!-- 风格切换 -->
		<div class="tpl-skiner">
			<div class="tpl-skiner-toggle am-icon-cog"></div>
			<div class="tpl-skiner-content">
				<div class="tpl-skiner-content-title">选择主题</div>
				<div class="tpl-skiner-content-bar">
					<span class="skiner-color skiner-white" data-color="theme-white"></span>
					<span class="skiner-color skiner-black" data-color="theme-black"></span>
				</div>
			</div>
		</div>
			
		<!-- 侧边导航栏 -->
		<div class="left-sidebar" id="leftMenu">
            
        </div>
		
		<!-- 确认模态框 -->
		<div class="am-modal am-modal-confirm" tabindex="-1" id="confirm">
		  <div class="am-modal-dialog">
		    <div class="am-modal-hd">信息</div>
		    <div class="am-modal-bd" id="descript">
		   		激活成功！
		    </div>
		    <div class="am-modal-footer">
		      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
		    </div>
		  </div>
		</div>
		
		<div class="am-modal am-modal-prompt" tabindex="-1" id="repairDialog">
			<div class="am-modal-dialog" id="repairDialogVue">
				<form class="am-form" method="post" id="repairForm">
					<fieldset>
						<legend>申请售后</legend>
							<div class="am-form-group">
								<label for="doc-ipt-email-1">申请类型</label> 
								<div>
								<span v-for="(item,index) in repair">
									<input type="radio" name="repair" :value="item" v-model="repairInfo.vcType">{{item}}
								</span>
								</div>
							</div>
							
							<div class="am-form-group" v-if="repairInfo.vcType=='换货'">
								<label for="doc-ipt-email-1">申请原因</label> 
								<div v-for="(item,index) in reasonReplace">
									<input type="radio" name="reason" :value="item" v-model="repairInfo.vcReason" required="required">{{item}}
								</div>
							</div>
							<div class="am-form-group" v-else>
								<label for="doc-ipt-email-1">具体原因</label> 
								<div v-for="(item,index) in reasonRepaire">
									<input type="radio" name="reason" :value="item" v-model="repairInfo.vcReason" required="required">{{item}}
								</div>
							</div>
							<div class="am-form-group">
								<label for="doc-ta-1">内容</label>
								<textarea rows="5" v-model="repairInfo.vcContent" required id="doc-ta-1" name="vcContent"></textarea>
							</div>
							
							<p>
								<button type="submit" class="am-btn am-btn-default">提交</button>
							</p>
						</p>
					</fieldset>
				</form>
			</div>
		</div>
		
		<!-- 模态框 -->
		<div class="am-modal am-modal-prompt" tabindex="-1" id="equipDialog">
			<div class="am-modal-dialog" id="equipDialogVue">
				<form class="am-form" method="post" id="equipForm">
					<fieldset>
						<legend>详情</legend>
							<div class="am-form-group">
								<label for="doc-ipt-email-1">设备名称</label> 
								<span>{{equip.vcName}}</span>
							</div>
							<div class="am-form-group" v-if="equip.nId!=null">
								<label for="doc-ipt-email-1">设备类型</label> 
								<span>{{equip.vcTypeName}}</span>
							</div>
							<div class="am-form-group" v-if="equip.nId!=null">
								<label for="doc-ipt-email-1">设备型号</label> 
								<span>{{equip.vcModel}}</span>
							</div>
							<div class="am-form-group">
								<label for="doc-ipt-email-1">厂商名称</label> 
								<span>{{equip.vcCompanyName}}</span>
							</div>
							<div class="am-form-group" v-if="equip.nId!=null">
								<label for="doc-ipt-email-1">售后联系电话</label> 
								<span>{{equip.vcTel}}</span>
							</div>
							<div class="am-form-group">
								<label for="doc-ipt-email-1">激活状态</label> 
								<span style="color: red;">{{equip.nId==null?"请扫描二维码激活":"已激活"}}</span>
							</div>
							<div class="am-form-group" v-if="equip.nId!=null">
								<label for="doc-ipt-email-1">激活时间</label> 
								<span>{{equip.dtReg | dateFmtYMDHMS}}</span>
							</div>
							<div class="am-form-group" v-if="equip.nId!=null">
								<button type="button" class="am-btn am-btn-default" @click="repair">申请售后</button>
							</div>
						</p>
					</fieldset>
				</form>
			</div>
		</div>
		
		<!-- 内容区域 -->
		<div class="tpl-content-wrapper" id="equipListVue">
			<div class="row-content am-cf">
				
				<div class="row" v-if="videoFlag">
            
	                <div  class="am-u-sm-12 am-u-md-12 am-u-lg-12">
	                    <div class="widget am-cf" style="text-align: center;">	
							<video id="video" class="am-round am-img-responsive"></video>
	                    </div>
	                </div>
	                
					<canvas id='canvas' width='400' height='300' style="display: none;"></canvas>
	    			<img id='img' src=''>
				</div>
				
				<div class="row">
					<div class="am-u-sm-12 am-u-md-12 am-u-lg-12">
						<div class="widget am-cf">
							<div class="widget-head am-cf">
								<div class="widget-title  am-cf"></div>
							</div>
							<div class="widget-body  am-fr">

							<div class="am-u-sm-12 am-u-md-6 am-u-lg-6">
								<div class="am-form-group">
									<div class="am-btn-toolbar">
										<div class="am-btn-group am-btn-group-xs">
											<button @click="openVideo" type="button" id="tack"
												class="am-btn am-btn-default am-btn-success">
												<span class="am-icon-camera"></span> 开启摄像头
											</button>
											
											<button type="button" @click="closeVideo"
												class="am-btn am-btn-default am-btn-danger">
												<span class="am-icon-close"></span> 关闭摄像头
											</button>
											<button type="button" @click="uploadImage"
												class="am-btn am-btn-default am-btn-danger">
												<span class="am-icon-close"></span> 测试拍摄
											</button>
										</div>
									</div>
								</div>
							</div>

							<div class="am-u-sm-12">
                                   <table width="100%" class="am-table am-table-compact am-table-striped tpl-table-black ">
                                       <thead>
                                           <tr>
                                               <th>序号</th>
                                               <th>设备名称</th>
                                               <th>设备厂商</th>
                                               <th>激活状态</th>
                                           </tr>
                                       </thead>
                                       <tbody>
                                           <tr class="even gradeC" v-for="(item,index) in equipList" @click="getDetail(item)">
                                              <td class="am-text-middle">{{index+1}}</td>
                                              <td class="am-text-middle" >{{item.vcName}}</td>
                                              <td class="am-text-middle">{{item.vcCompanyName}}</td>
                                              <td class="am-text-middle">{{item.nId==null?"未激活":"已激活"}}</td>
                                              <td class="am-text-middle">
                                                  <div class="tpl-table-black-operation">
                                                  		
                                                  </div>
                                               </td>
                                           </tr>
                                       </tbody>
                                   </table>
                               </div>
							<div class="am-u-lg-12 am-cf">
								<div id="pagination" class="m-pagination"
									style="margin-left: 40%; float: none; margin-top: 10%;"></div>
							</div>
						</div>
					</div>
				</div>
			</div>	
		</div>
	</div>

	</div>
	</div>
	<script src="../../js/amazeUI/assets/js/amazeui.min.js"></script>
	<script src="../../js/amazeUI/assets/js/amazeui.datatables.min.js"></script>
	<script src="../../js/amazeUI/assets/js/dataTables.responsive.min.js"></script>
	<script src="../../js/amazeUI/assets/js/app.js"></script>

	<script src="../../js/vue.js"></script>
	<script type="text/javascript"
		src="../../js/amazeUI/assets/js/axios.min.js"></script>
	<script type="text/javascript" src="../../js/common/init-menu-vue.js"></script>
	<script type="text/javascript" src="../../js/common/left-menu.js"></script>
	<script type="text/javascript">
		var repairDialogVue = new Vue({
			el : '#repairDialogVue',
			data : {
				repairInfo:{"vcType":"维修","vcReason":"无法采集数据"},
				repair:["换货","维修"],
				reasonReplace:["质量不合格","功能缺少","和商家描述差距太大","物流太慢","未收到货","7天无理由换货"],
				reasonRepaire:["无法采集数据","无法正常运行","电池持久问题","外观材料缺失","手机端软件不兼容"]
			},
			methods : {
				submit : function(){
					var params=JSON.stringify(repairDialogVue.repairInfo);
					this.$http.put("repair/repair",params).then(function(res) {
						var data=res.data;
						if(data.status==200){
							alert(data.msg);
							$('#repairDialog').modal('close');
						}
					}).catch(function(){
					    alert("出错了");
					});
				}
			}
		});
	
		var equipDialogVue = new Vue({
			el : '#equipDialogVue',
			data : {
				equip:{}
			},
			methods : {
				repair : function(item){
					repairDialogVue.repairInfo.nEquipId=equipDialogVue.equip.nId;
					$('#equipDialog').modal('close');
					$('#repairDialog').modal({
						relatedTarget: this
					});
				}
			}
		});
		
		var equipListVue = new Vue({
			el : '#equipListVue',
			data : {
				equipList : [],
				videoFlag: false,
				video : {}
			},
			mounted : function(){
				
			},
			methods : {
				getDetail : function(item){
					equipDialogVue.equip=clone(item);
					$('#equipDialog').modal({
						relatedTarget: this
					});
				},
				openVideo : function(){
					$.AMUI.progress.start();
					equipListVue.videoFlag=true;
					setTimeout(function(){
						equipListVue.initVideo();
						$.AMUI.progress.done();
					}, 1000);
				},
				initVideo : function(){
					var video = document.getElementById('video'),
			        canvas = document.getElementById('canvas'),
			        snap = document.getElementById('tack'),
			        img = document.getElementById('img'),
			        vendorUrl = window.URL || window.webkitURL;
				    //媒体对象
				    navigator.getMedia = navigator.getUserMedia ||
				                         navagator.webkitGetUserMedia ||
				                         navigator.mozGetUserMedia ||
				                         navigator.msGetUserMedia;
				    navigator.getMedia({
				        video: true, //使用摄像头对象
				        audio: false  //不用音频
				    }, function(strem){
				        console.log(strem);
				        video.src = vendorUrl.createObjectURL(strem);
				        video.play();
				    }, function(error) {
				        console.log(error);
				    });
				    
				    equipListVue.uploadImage();
				    equipListVue.video=setInterval(function(){
				    	equipListVue.uploadImage();
			        }, 1000);
			},
	        closeVideo : function(){
	        	equipListVue.videoFlag=false;
				clearInterval(equipListVue.video);
	        },
	        uploadImage : function(){
	        	canvas = document.getElementById('canvas');
				canvas.getContext('2d').drawImage(video, 0, 0, 400, 300);
		        imgData = canvas.toDataURL();
		        
	        	this.$http.post("file/qrcode",JSON.stringify({"imgData":imgData})).then(function(res) {
					var data=res.data;
					if(data.status==200){
						equipListVue.videoFlag=false;
						clearInterval(equipListVue.video);
						if(data.data==null){
							$('#confirm').modal({
								relatedTarget: this
							});
							reloadTable();
							
						}else{
							equipDialogVue.equip=clone(data.data);
							$('#equipDialog').modal({
								relatedTarget: this
							});
						}
					}
				}).catch(function(){
				    alert("出错了");
				});
        	}
		}
	})
	</script>
	<script type="text/javascript">
	$(function() {
		var baseUrl=host+'/equip/codeInfo';
		$("#pagination").css('float', 'none');
		$("#pagination").pagination({
			remote : {
				beforeSend: $.AMUI.progress.start(), 
				complete: $.AMUI.progress.done(),
				url : baseUrl,
				success : function(result) {
					equipListVue.equipList = result.rows;
				}
			}
		});
	})
	
	//重新载入tableList信息
	function reloadTable(){
		var url = host+'/equip/codeInfo';
   	    $("#pagination").pagination('setRemoteUrl', url);
   	   	$("#pagination").pagination('remote');
	}

	$('#repairDialog').validator({
        validateOnSubmit: true,
        submit: function() {
            if(this.isFormValid()) {
            	repairDialogVue.submit();
            	return false;
            }
            return false;
        }
	});
	</script>
</body>

</html>